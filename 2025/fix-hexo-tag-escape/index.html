<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zombie12138.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="之前一直使用 hexo-reference-plus 作为插件渲染的工具, 但是最近突然会导致渲染失败. 排查问题发现是 hexo 本身的 bug.">
<meta property="og:type" content="article">
<meta property="og:title" content="给 Hexo 提交 PR">
<meta property="og:url" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/index.html">
<meta property="og:site_name" content="zombie&#39;s">
<meta property="og:description" content="之前一直使用 hexo-reference-plus 作为插件渲染的工具, 但是最近突然会导致渲染失败. 排查问题发现是 hexo 本身的 bug.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/good_case.png">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/bad_case.png">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/render_failed.png">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/blame.png">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/fix_blame.png">
<meta property="og:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/validation.png">
<meta property="article:published_time" content="2025-02-20T00:30:22.000Z">
<meta property="article:modified_time" content="2025-02-20T01:18:36.364Z">
<meta property="article:author" content="zombie12138">
<meta property="article:tag" content="hexo">
<meta property="article:tag" content="js">
<meta property="article:tag" content="Github">
<meta property="article:tag" content="OpenSource">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zombie12138.github.io/2025/fix-hexo-tag-escape/good_case.png">

<link rel="canonical" href="https://zombie12138.github.io/2025/fix-hexo-tag-escape/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>给 Hexo 提交 PR | zombie's</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">zombie's</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zombie12138.github.io/2025/fix-hexo-tag-escape/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zombie12138">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zombie's">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          给 Hexo 提交 PR
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-20 08:30:22 / 修改时间：09:18:36" itemprop="dateCreated datePublished" datetime="2025-02-20T08:30:22+08:00">2025-02-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前一直使用 hexo-reference-plus 作为插件渲染的工具, 但是最近突然会导致渲染失败. 排查问题发现是 hexo 本身的 bug.</p>
<span id="more"></span>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>一般来说, 我的参考链接都是直接用 markdown 的链接放到引用位置; 但是有些时候, 希望集中放一下文章的参考引用, 以及论文的引用, 这时候需要使用引用插件. 我使用的是一个 hexo-reference-plus 的插件, 还算比较好用. 但是最近突然会影响文章的解析和渲染, 在第一个 <code>&#123;% ref xxx %&#125;</code> 标签后面的几乎所有的 markdown 都停止了渲染. 来排查一下.</p>
<p>本人对于 hexo &amp; js &amp; nodejs 都不熟悉, 只是为了快速解决问题. 因此可能有些降智操作.</p>
<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>正常的渲染的语法是</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxx &#123;% ref reftag %&#125;</span><br><span class="line"><span class="section"># Title</span></span><br><span class="line">&#123;% references %&#125;</span><br><span class="line">[reftag] &#123;% post<span class="emphasis">_link hello-world hello-world %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% endreferences %&#125;</span></span><br></pre></td></tr></table></figure>

<p>渲染的效果见 <a href="/2021/hello-world/" title="Hello World">hello-world</a>:</p>
<img src="/2025/fix-hexo-tag-escape/good_case.png" class="" title="正常渲染">

<p>但是最近遇到了问题, 所有的第一个 Ref 之后的 MD 语法 (除了代码块和一些 hexo 自带的 tag) 都无法渲染:</p>
<img src="/2025/fix-hexo-tag-escape/bad_case.png" class="" title="未正确渲染">

<h3 id="版本使用"><a href="#版本使用" class="headerlink" title="版本使用"></a>版本使用</h3><p>使用的版本如下 (<code>package.json</code>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;hexo-site&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;hexo generate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;clean&quot;</span>: <span class="string">&quot;hexo clean&quot;</span>,</span><br><span class="line">    <span class="string">&quot;deploy&quot;</span>: <span class="string">&quot;hexo deploy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: <span class="string">&quot;hexo server&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hexo&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;7.3.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;hexo&quot;</span>: <span class="string">&quot;^7.3.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-deployer-git&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-generator-archive&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-generator-category&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-generator-index&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-generator-sitemap&quot;</span>: <span class="string">&quot;^3.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-generator-tag&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-reference-plus&quot;</span>: <span class="string">&quot;^1.1.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-renderer-ejs&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-renderer-marked&quot;</span>: <span class="string">&quot;^7.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-renderer-stylus&quot;</span>: <span class="string">&quot;^3.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-server&quot;</span>: <span class="string">&quot;^3.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-theme-landscape&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h3><p>最小测试环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install npm</span><br><span class="line"><span class="built_in">sudo</span> npm install hexo@7.3.0 -g</span><br><span class="line">hexo init testenv</span><br><span class="line"><span class="built_in">cd</span> testenv</span><br><span class="line">npm install hexo-reference-plus</span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">source</span>/_posts/</span><br><span class="line"><span class="built_in">tee</span> &gt;hello-world.md  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">title: Hello World</span></span><br><span class="line"><span class="string">date: 2021-10-09 21:50:25</span></span><br><span class="line"><span class="string">refplus: true</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;!-- more --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Test &#123;% ref self %&#125;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Ref</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;% references %&#125;</span></span><br><span class="line"><span class="string">[self] &#123;% post_link hello-world hello-world %&#125;</span></span><br><span class="line"><span class="string">&#123;% endreferences %&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><h3 id="hexo-reference-plus"><a href="#hexo-reference-plus" class="headerlink" title="hexo-reference-plus"></a>hexo-reference-plus</h3><p>首先怀疑的是插件一些用法不是很标准, 来查看一下插件的写法.</p>
<p>查看 <code>node_modules/hexo_reference_plus/index.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> htmlReplacer = <span class="built_in">require</span>(<span class="string">&#x27;./src/htmlReplacer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> referParser = <span class="built_in">require</span>(<span class="string">&#x27;./src/referParser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; config &#125; = hexo;</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;references&#x27;</span>, <span class="keyword">function</span> (<span class="params">args, content</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> reference = <span class="title function_">referParser</span>(content)</span><br><span class="line">    <span class="keyword">let</span> addStlye = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span>(args.<span class="title function_">includes</span>(<span class="string">&quot;hide&quot;</span>)) addStlye+=<span class="string">&quot;display:none;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;ul id=&#x27;refplus&#x27; style=&quot;<span class="subst">$&#123;addStlye&#125;</span>&quot;&gt;<span class="subst">$&#123;reference.join(<span class="string">&#x27;&#x27;</span>)&#125;</span>&lt;/ul&gt;`</span>;</span><br><span class="line">&#125;, &#123; <span class="attr">ends</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;ref&#x27;</span>, <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    args = args.<span class="title function_">map</span>(<span class="function"><span class="params">arg</span> =&gt;</span> <span class="string">`&lt;sup class=&#x27;refplus-num&#x27;&gt;&lt;a href=&quot;#ref-<span class="subst">$&#123;arg&#125;</span>&quot;&gt;[<span class="subst">$&#123;arg&#125;</span>]&lt;/a&gt;&lt;/sup&gt;`</span>)</span><br><span class="line">    <span class="keyword">return</span> args.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;after_post_render&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(data.<span class="property">refplus</span>)) <span class="keyword">return</span> data;</span><br><span class="line">    data.<span class="property">content</span> = <span class="title function_">htmlReplacer</span>(data.<span class="property">content</span>);</span><br><span class="line">    data.<span class="property">content</span> += <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>上面的这段代码, 注册了两个 <code>tag</code> 和一个 <code>after_post_render</code> 来进行 tag 的渲染和最终的格式的添加 (最终注册到了 <code>nunjucks</code> 库上). 在上面的问题中, 这些 tag 确实正确渲染了, 但是正常的 md 没有被渲染, 所以怀疑是不是这些 tag 渲染出来的 html 标签干扰了 md 的渲染, 但是修改 tag 的方法依然无法正确渲染.</p>
<h3 id="hexo-renderer-marked"><a href="#hexo-renderer-marked" class="headerlink" title="hexo-renderer-marked"></a>hexo-renderer-marked</h3><p>markdown 是用的 hexo-renderer-marked 调用 marked 进行渲染的, 于是查看其源代码, 打开 <code>node_modules/hexo-renderer-marked/lib/renderer.js</code> 查看, 添加了 log.</p>
<p>发现, 除了第一个 title, 其他后面的 md 标签完全没有渲染, 先看看 hexo 是怎么做的.</p>
<h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><p>主要的代码集中在 <code>node_modules/hexo/dist/hexo/post.js</code>, 添加日志打印:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params">source, data = &#123;&#125;, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">context</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; config &#125; = ctx;</span><br><span class="line">    <span class="keyword">const</span> &#123; tag &#125; = ctx.<span class="property">extend</span>;</span><br><span class="line">    <span class="keyword">const</span> ext = data.<span class="property">engine</span> || (source ? (<span class="number">0</span>, path_1.<span class="property">extname</span>)(source) : <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> promise;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">content</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">        promise = bluebird_1.<span class="property">default</span>.<span class="title function_">resolve</span>(data.<span class="property">content</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(promise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (source) &#123;</span><br><span class="line">        <span class="comment">// Read content from files</span></span><br><span class="line">        promise = (<span class="number">0</span>, hexo_fs_1.<span class="property">readFile</span>)(source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bluebird_1.<span class="property">default</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;No input file or string!&#x27;</span>)).<span class="title function_">asCallback</span>(callback);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Files like js and css are also processed by this function, but they do not require preprocessing like markdown</span></span><br><span class="line">    <span class="comment">// data.source does not exist when tag plugins call the markdown renderer</span></span><br><span class="line">    <span class="keyword">const</span> isPost = !data.<span class="property">source</span> || [<span class="string">&#x27;html&#x27;</span>, <span class="string">&#x27;htm&#x27;</span>].<span class="title function_">includes</span>(ctx.<span class="property">render</span>.<span class="title function_">getOutput</span>(data.<span class="property">source</span>));</span><br><span class="line">    <span class="keyword">if</span> (!isPost) &#123;</span><br><span class="line">        <span class="keyword">return</span> promise.<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">            data.<span class="property">content</span> = content;</span><br><span class="line">            ctx.<span class="property">log</span>.<span class="title function_">debug</span>(<span class="string">&#x27;Rendering file: %s&#x27;</span>, (<span class="number">0</span>, picocolors_1.<span class="property">magenta</span>)(source));</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">render</span>.<span class="title function_">render</span>(&#123;</span><br><span class="line">                <span class="attr">text</span>: data.<span class="property">content</span>,</span><br><span class="line">                <span class="attr">path</span>: source,</span><br><span class="line">                <span class="attr">engine</span>: data.<span class="property">engine</span>,</span><br><span class="line">                <span class="attr">toString</span>: <span class="literal">true</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">            data.<span class="property">content</span> = content;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;).<span class="title function_">asCallback</span>(callback);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// disable Nunjucks when the renderer specify that.</span></span><br><span class="line">    <span class="keyword">let</span> disableNunjucks = ext &amp;&amp; ctx.<span class="property">render</span>.<span class="property">renderer</span>.<span class="title function_">get</span>(ext) &amp;&amp; !!ctx.<span class="property">render</span>.<span class="property">renderer</span>.<span class="title function_">get</span>(ext).<span class="property">disableNunjucks</span>;</span><br><span class="line">    <span class="comment">// front-matter overrides renderer&#x27;s option</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data.<span class="property">disableNunjucks</span> === <span class="string">&#x27;boolean&#x27;</span>)</span><br><span class="line">        disableNunjucks = data.<span class="property">disableNunjucks</span>;</span><br><span class="line">    <span class="keyword">const</span> cacheObj = <span class="keyword">new</span> <span class="title class_">PostRenderEscape</span>();</span><br><span class="line">    <span class="keyword">return</span> promise.<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">        data.<span class="property">content</span> = content;</span><br><span class="line">        <span class="comment">// Run &quot;before_post_render&quot; filters</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">execFilter</span>(<span class="string">&#x27;before_post_render&#x27;</span>, data, &#123; <span class="attr">context</span>: ctx &#125;);</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">        data.<span class="property">content</span> = cacheObj.<span class="title function_">escapeCodeBlocks</span>(data.<span class="property">content</span>);</span><br><span class="line">        <span class="comment">// Escape all Nunjucks/Swig tags</span></span><br><span class="line">        <span class="keyword">if</span> (disableNunjucks === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---------------Before Escape-----------------&#x27;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">            data.<span class="property">content</span> = cacheObj.<span class="title function_">escapeAllSwigTags</span>(data.<span class="property">content</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---------------After Escape-----------------&#x27;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> options = data.<span class="property">markdown</span> || &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span> (!config.<span class="property">syntax_highlighter</span>)</span><br><span class="line">            options.<span class="property">highlight</span> = <span class="literal">null</span>;</span><br><span class="line">        ctx.<span class="property">log</span>.<span class="title function_">debug</span>(<span class="string">&#x27;Rendering post: %s&#x27;</span>, (<span class="number">0</span>, picocolors_1.<span class="property">magenta</span>)(source));</span><br><span class="line">        <span class="comment">// Render with markdown or other renderer</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">render</span>.<span class="title function_">render</span>(&#123;</span><br><span class="line">            <span class="attr">text</span>: data.<span class="property">content</span>,</span><br><span class="line">            <span class="attr">path</span>: source,</span><br><span class="line">            <span class="attr">engine</span>: data.<span class="property">engine</span>,</span><br><span class="line">            <span class="attr">toString</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="title function_">onRenderEnd</span>(<span class="params">content</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---------------onRenderEnd-----------------&#x27;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">                <span class="comment">// Replace cache data with real contents</span></span><br><span class="line">                data.<span class="property">content</span> = cacheObj.<span class="title function_">restoreAllSwigTags</span>(content);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---------------after restoreAllSwigTags-----------------&#x27;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">                <span class="comment">// Return content after replace the placeholders</span></span><br><span class="line">                <span class="keyword">if</span> (disableNunjucks)</span><br><span class="line">                    <span class="keyword">return</span> data.<span class="property">content</span>;</span><br><span class="line">                <span class="comment">// Render with Nunjucks</span></span><br><span class="line">                <span class="keyword">return</span> tag.<span class="title function_">render</span>(data.<span class="property">content</span>, data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, options);</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---------------after tag-----------------&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">        data.<span class="property">content</span> = cacheObj.<span class="title function_">restoreCodeBlocks</span>(content);</span><br><span class="line">        <span class="comment">// Run &quot;after_post_render&quot; filters</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">execFilter</span>(<span class="string">&#x27;after_post_render&#x27;</span>, data, &#123; <span class="attr">context</span>: ctx &#125;);</span><br><span class="line">    &#125;).<span class="title function_">asCallback</span>(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常渲染过程应该是:</p>




<p>可以看到大致过程如下:</p>
<ol>
<li>Escape: <code>escapeCodeBlocks</code> 已经将代码块 escape 成了 <code>&lt;!--code 1--&gt;</code> 这样的标签; 而 <code>escapeAllSwigTags</code> 就是把 Hexo 的 tag 改成 <code>&lt;!--Swig 4--&gt;</code>. 这些东西保存起来, 避免影响后续渲染</li>
<li>调用 render, <code>Hexo.extend.renderer</code> 中保存了注册的渲染方法, 插件 <code>hexo-renderer-marked</code> 注册了 <code>md</code> 的渲染, 渲染最终使用的 <code>marked</code></li>
<li>把之前的 swig tag 全部恢复</li>
<li>渲染这些 tag, 就是执行的之前注册的 <code>ref</code> 的渲染, 调用的是 <code>nunjucks</code> 的 <code>renderString</code>.</li>
<li>恢复代码块</li>
</ol>
<p>但是添加了 ref 标签之后, 后面所有的内容都被 escape 了, 没有参与 marked 的渲染:</p>
<img src="/2025/fix-hexo-tag-escape/render_failed.png" class="" title="错误渲染过程">

<p>不难看出, 问题出现在了 <code>escapeAllSwigTags</code> 中, 查看其源代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> idx = <span class="number">0</span>; idx &lt; length; idx++) &#123;</span><br><span class="line">  <span class="keyword">const</span> char = str[idx];</span><br><span class="line">  <span class="keyword">const</span> next_char = str[idx + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> (state === <span class="variable constant_">STATE_PLAINTEXT</span>) &#123; <span class="comment">// From plain text to swig</span></span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next_char === <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">        state = <span class="variable constant_">STATE_SWIG_TAG</span>;</span><br><span class="line">        idx++;</span><br><span class="line">        swig_tag_name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        swig_full_tag_start_buffer = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        swig_tag_name_begin = <span class="literal">false</span>; <span class="comment">// Mark if it is the first non white space char in the swig tag</span></span><br><span class="line">        swig_tag_name_end = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        output += char;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      output += char;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="variable constant_">STATE_SWIG_TAG</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;%&#x27;</span> &amp;&amp; next_char === <span class="string">&#x27;&#125;&#x27;</span>) &#123; <span class="comment">// From swig back to plain text</span></span><br><span class="line">      idx++;</span><br><span class="line">      <span class="keyword">if</span> (swig_tag_name !== <span class="string">&#x27;&#x27;</span> &amp;&amp; str.<span class="title function_">includes</span>(<span class="string">`end<span class="subst">$&#123;swig_tag_name&#125;</span>`</span>)) &#123;</span><br><span class="line">        state = <span class="variable constant_">STATE_SWIG_FULL_TAG</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        swig_tag_name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        state = <span class="variable constant_">STATE_PLAINTEXT</span>;</span><br><span class="line">        output += <span class="title class_">PostRenderEscape</span>.<span class="title function_">escapeContent</span>(<span class="variable language_">this</span>.<span class="property">stored</span>, <span class="string">&#x27;swig&#x27;</span>, <span class="string">`&#123;%<span class="subst">$&#123;buffer&#125;</span>%&#125;`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到, 是一个状态机的写法, 查找到一个 tag, 比如 <code>ref</code>, 如何判断是否需要闭合呢? 首先查看是否下文存在 <code>endref</code>, 而代码中有 <code>endreference</code> 标签. 就一直到结尾才匹配到.</p>
<h2 id="问题修复"><a href="#问题修复" class="headerlink" title="问题修复"></a>问题修复</h2><h3 id="Blame"><a href="#Blame" class="headerlink" title="Blame"></a>Blame</h3><p>显然, 是 hexo 的, 原因有:</p>
<ol>
<li>之前可以用, 但是现在不能用</li>
<li>任何标签不能是另一个块标签的前缀, 比如 <code>ref</code> 和 <code>reference</code> 不能同时出现, 显然不合理; 甚至会和正文中的 endref 起冲突.</li>
</ol>
<p>什么时候引入的?</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/blame/70efca7388d7f8dd3ff1a40e691a19c9dd27f378/lib/hexo/post.ts">Blame</a> 可以看到是一次 4 年前的更新对于这部分有较大的改动, 是这个时候引入的</li>
</ul>
<img src="/2025/fix-hexo-tag-escape/blame.png" class="" title="blame">

<p>为什么之前没有发生?</p>
<ul>
<li>因为之前一直在 tx 的服务器, 21 年部署, 一直没有更新 hexo 版本.</li>
</ul>
<p>之前的版本为什么没有这个 Bug</p>
<ul>
<li>之前的代码是直接进行正则替换的, 因为是最小匹配, 不会有这种问题:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rSwigVarAndComment = <span class="regexp">/&#123;[&#123;#][\s\S]+?[&#125;#]&#125;/g</span>;</span><br><span class="line"><span class="keyword">const</span> rSwigFullBlock = <span class="regexp">/&#123;% *(\S+?)(?: *| +.+?)%&#125;[\s\S]+?&#123;% *end\1 *%&#125;/g</span>;</span><br><span class="line"><span class="keyword">const</span> rSwigBlock = <span class="regexp">/&#123;%[\s\S]+?%&#125;/g</span>;</span><br><span class="line"><span class="title function_">escapeAllSwigTags</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">escape</span> = _str =&gt; <span class="title function_">_escapeContent</span>(<span class="variable language_">this</span>.<span class="property">cache</span>, <span class="string">&#x27;swig&#x27;</span>, _str);</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">replace</span>(rSwigVarAndComment, <span class="built_in">escape</span>) <span class="comment">// Remove swig comment first to reduce string size being matched next</span></span><br><span class="line">      .<span class="title function_">replace</span>(rSwigFullBlock, <span class="built_in">escape</span>) <span class="comment">// swig full block must escaped before swig block to avoid confliction</span></span><br><span class="line">      .<span class="title function_">replace</span>(rSwigBlock, <span class="built_in">escape</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发现被修复"><a href="#发现被修复" class="headerlink" title="发现被修复?"></a>发现被修复?</h3><p>这也是够邪门的, 四年的老 Bug, 一直没有人修复, 我 2025&#x2F;2&#x2F;9 周日放假看的这个问题, 2025&#x2F;2&#x2F;15 再看已经找不到当时的问题代码了, 看了一下日志, 是两天前被人修复了.</p>
<img src="/2025/fix-hexo-tag-escape/fix_blame.png" class="" title="修复bug">

<p>这也是够邪门的, 但是仔细看了下, 他的这个提交是为了修复 <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/pull/5618">其他的问题</a>:</p>
<p>但是这个是不是修复了本次的问题呢, 来分析以下, 改的也可以说是非常抽象:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (idx &lt; length) &#123;</span><br><span class="line">  <span class="keyword">while</span> (idx &lt; length) &#123;</span><br><span class="line">    <span class="keyword">const</span> char = str[idx];</span><br><span class="line">    <span class="keyword">const</span> next_char = str[idx + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (state === <span class="variable constant_">STATE_PLAINTEXT</span>) &#123; <span class="comment">// From plain text to swig</span></span><br><span class="line">      <span class="keyword">if</span> (char === <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// check if it is a complete tag &#123;&#123; &#125;&#125;</span></span><br><span class="line">        <span class="keyword">if</span> (next_char === <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">          state = <span class="variable constant_">STATE_SWIG_VAR</span>;</span><br><span class="line">          idx++;</span><br><span class="line">          swig_start_idx[state] = idx;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next_char === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          state = <span class="variable constant_">STATE_SWIG_COMMENT</span>;</span><br><span class="line">          idx++;</span><br><span class="line">          swig_start_idx[state] = idx;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next_char === <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">          state = <span class="variable constant_">STATE_SWIG_TAG</span>;</span><br><span class="line">          idx++;</span><br><span class="line">          swig_tag_name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">          swig_full_tag_start_buffer = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">          swig_tag_name_begin = <span class="literal">false</span>; <span class="comment">// Mark if it is the first non white space char in the swig tag</span></span><br><span class="line">          swig_tag_name_end = <span class="literal">false</span>;</span><br><span class="line">          swig_start_idx[state] = idx;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          output += char;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        output += char;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="variable constant_">STATE_SWIG_TAG</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (char === <span class="string">&#x27;&quot;&#x27;</span> || char === <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (swig_string_quote === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">          swig_string_quote = char;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (swig_string_quote === char) &#123;</span><br><span class="line">          swig_string_quote = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// &#123;% &#125; or &#123;% %</span></span><br><span class="line">      <span class="keyword">if</span> (((char !== <span class="string">&#x27;%&#x27;</span> &amp;&amp; next_char === <span class="string">&#x27;&#125;&#x27;</span>) || (char === <span class="string">&#x27;%&#x27;</span> &amp;&amp; next_char !== <span class="string">&#x27;&#125;&#x27;</span>)) &amp;&amp; swig_string_quote === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// From swig back to plain text</span></span><br><span class="line">        swig_tag_name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        state = <span class="variable constant_">STATE_PLAINTEXT</span>;</span><br><span class="line">        output += <span class="string">`&#123;%<span class="subst">$&#123;buffer&#125;</span><span class="subst">$&#123;char&#125;</span>`</span>;</span><br><span class="line">        buffer = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;%&#x27;</span> &amp;&amp; next_char === <span class="string">&#x27;&#125;&#x27;</span> &amp;&amp; swig_string_quote === <span class="string">&#x27;&#x27;</span>) &#123; <span class="comment">// From swig back to plain text</span></span><br><span class="line">        idx++;</span><br><span class="line">        <span class="keyword">if</span> (swig_tag_name !== <span class="string">&#x27;&#x27;</span> &amp;&amp; str.<span class="title function_">includes</span>(<span class="string">`end<span class="subst">$&#123;swig_tag_name&#125;</span>`</span>)) &#123;</span><br><span class="line">          state = <span class="variable constant_">STATE_SWIG_FULL_TAG</span>;</span><br><span class="line">          swig_start_idx[state] = idx;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          swig_tag_name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">          state = <span class="variable constant_">STATE_PLAINTEXT</span>;</span><br><span class="line">          output += <span class="title class_">PostRenderEscape</span>.<span class="title function_">escapeContent</span>(<span class="variable language_">this</span>.<span class="property">stored</span>, <span class="string">&#x27;swig&#x27;</span>, <span class="string">`&#123;%<span class="subst">$&#123;buffer&#125;</span>%&#125;`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        buffer = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先就是这个格式非常不优雅, 两层 <code>while</code> 但是仅仅是为了实现一个控制流程的跳转, 是非常丑陋的. 其次就是 <code>if</code> 不管是性能还是可读性都不如 <code>switch</code>, 这个本来还算简单的 escape 变得非常复杂.</p>
<p>最后看以下有没有被修复, 可以看到, 依然是之前的逻辑, 使用 <code>endxxx</code> 来判断是否是一个块 Block.</p>
<h3 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h3><p>有以下几种方案</p>
<ol>
<li><strong>注册的时候记录 block 类型</strong>, 记录在一个表中, 状态机中判断是否需要闭合不通过关键字, 而是查表</li>
<li>使用更加<strong>复杂的正则表达式来匹配结尾</strong>; 为了优化, 可以在 escape 之前先匹配一遍形如 <code>&#123;% endxxxxx %&#125;</code> 的, 并且记录.</li>
<li>直接进行更复杂的语法分析.</li>
</ol>
<p>显然 <code>1</code> 最自然, 最准确; <code>2</code> 其次, 最直接; <code>3</code> 是最复杂, 改动最大, 是最难以实现的.</p>
<h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><p>因为之前没有接触郭 nodejs, 之前的操作全都是在 <code>node_modules</code> 下面直接改的, 但是这里 debug 肯定换个正式点的方法比较好. 参考了一下 <a target="_blank" rel="noopener" href="https://juejin.cn/post/7160595423395053598">博客</a>, 有几种方法</p>
<p>代码的导入可以使用路径的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xxx <span class="keyword">from</span> <span class="string">&#x27;my-npm&#x27;</span></span><br><span class="line"><span class="keyword">const</span> xxx = <span class="built_in">require</span>(<span class="string">&#x27;my-npm&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>也可以修改 dependencies 的路径</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my-npm&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:包的路径&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>npm link, 进入项目地址, 使用 <code>npm link</code>, 软链接到全局, 博客目录执行<code>npm link hexo</code>, 用完之后 <code>npm unlink hexo</code> 就可以了.</p>
<p>第三种就是使用 yalc.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:hexojs/hexo.git</span><br><span class="line">cd hexo</span><br><span class="line">sudo pacman -S typescript</span><br><span class="line">npm install --save-dev @types/node @types/mocha</span><br><span class="line">npm build</span><br><span class="line">npm link</span><br><span class="line">cd path/to/blog</span><br><span class="line">npm link hexo</span><br><span class="line">ls node_modules -al | grep hexo</span><br><span class="line">lrwxrwxrwx   1 root     root        17 Feb 15 23:04 hexo -&gt; ../../../dev/hexo</span><br></pre></td></tr></table></figure>

<h3 id="修复实现-通过记录标签类型"><a href="#修复实现-通过记录标签类型" class="headerlink" title="修复实现 (通过记录标签类型)"></a>修复实现 (通过记录标签类型)</h3><p>先不重构这个函数, 先解决我的问题. 首先是快速验证是否所有的 tag 都会走 <code>lib/extend/tag.ts</code> (之前用的路径一直是编译出来的 js, 这里看的就是真实 ts 源码了) 的注册逻辑.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">register</span>(<span class="attr">name</span>: string, <span class="attr">fn</span>: <span class="title class_">TagFunction</span>, options?: <span class="title class_">RegisterOptions</span> | boolean):<span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!name) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;name is required&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">&#x27;function&#x27;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;fn must be a function&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options == <span class="literal">null</span> || <span class="keyword">typeof</span> options === <span class="string">&#x27;boolean&#x27;</span>) &#123;</span><br><span class="line">    options = &#123; <span class="attr">ends</span>: options <span class="keyword">as</span> boolean &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">tag</span>: <span class="title class_">NunjucksTag</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">async</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">asyncFn</span>: <span class="title class_">AsyncTagFunction</span>;</span><br><span class="line">    <span class="keyword">if</span> (fn.<span class="property">length</span> &gt; <span class="number">2</span>) &#123;</span><br><span class="line">      asyncFn = <span class="title class_">Promise</span>.<span class="title function_">promisify</span>(fn);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      asyncFn = <span class="title class_">Promise</span>.<span class="title function_">method</span>(fn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ends</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Result for tag [&quot;</span> + name + <span class="string">&quot;] is:&quot;</span> + <span class="title class_">String</span>(options.<span class="property">ends</span>));</span><br><span class="line">      tag = <span class="keyword">new</span> <span class="title class_">NunjucksAsyncBlock</span>(name, asyncFn);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      tag = <span class="keyword">new</span> <span class="title class_">NunjucksAsyncTag</span>(name, asyncFn);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">ends</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Result for tag [&quot;</span> + name + <span class="string">&quot;] is:&quot;</span> + <span class="title class_">String</span>(options.<span class="property">ends</span>));</span><br><span class="line">    tag = <span class="keyword">new</span> <span class="title class_">NunjucksBlock</span>(name, fn);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tag = <span class="keyword">new</span> <span class="title class_">NunjucksTag</span>(name, fn);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">env</span>.<span class="title function_">addExtension</span>(name, tag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到, 确实 hexo 的 tag 全都注册了</p>
<img src="/2025/fix-hexo-tag-escape/validation.png" class="" title="注册日志">

<p>修改代码, 注册时候放入 table, 取消注册的时候拿走, 然后不再使用字符串匹配解决. 注册添加 <code>this.blockTagMap[name] = !!options.ends;</code>, 取消注册添加 <code>delete this.blockTagMap[name];</code>, <code>escapeAllSwigTags</code> 对用的时候, 判断是否是 blockTag 时候使用 <code>swig_tag_name !== &#39;&#39; &amp;&amp; (blockTagMap[swig_tag_name] ?? false)</code> 判断.</p>
<p>测试是正常的, <code>npm test</code> 可以跑一下单侧. 发现 raw 不在注册中, 是 Nunjucks 模板引擎渲染的时候的直接处理的, 这样很多内部的就没法进行注册了. 除非从 nunjucks 内部拿标签状态, 或者直接 <a target="_blank" rel="noopener" href="https://mozilla.github.io/nunjucks/templating.html#tags">所有的标签</a> 手动添加进去. 重新执行单侧, 全部通过.</p>
<h3 id="修复实现-通过正则匹配"><a href="#修复实现-通过正则匹配" class="headerlink" title="修复实现 (通过正则匹配)"></a>修复实现 (通过正则匹配)</h3><p>本来想开头匹配所有的 <code>&#123;% endxxxx %&#125;</code> 但是这个正则怎么写不确认, GPT 说, 可以 underscore, 但是不可以 hyphen, 看源码实现太复杂, 看 <a target="_blank" rel="noopener" href="https://mozilla.github.io/nunjucks/api.html#custom-tags">文档</a> 也没有提到. 考虑到本身的匹配的类型比较单一, 直接使用 <code>&#123;%\s*end([\w_]+)\s*%&#125;</code> 匹配.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rBlockSwigTagName = <span class="regexp">/&#123;%\s*end([\w_]+)\s*%&#125;/g</span>;</span><br><span class="line"><span class="keyword">const</span> end_swig_tags = <span class="keyword">new</span> <span class="title class_">Set</span>(</span><br><span class="line">  <span class="title class_">Array</span>.<span class="title function_">from</span>(str.<span class="title function_">matchAll</span>(rBlockSwigTagName), <span class="function">(<span class="params">[, tag]</span>) =&gt;</span> tag)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态机代码中</span></span><br><span class="line"><span class="keyword">if</span> (swig_tag_name !== <span class="string">&#x27;&#x27;</span> &amp;&amp; end_swig_tags.<span class="title function_">has</span>(swig_tag_name)) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>也可以每一个都去匹配, 比如一个 tag 叫 <code>raw</code>, 就匹配 <code>&#123;%\s*endraw\s*%&#125;</code>, 但是看里面的管理员对于性能要求还是比较高的, 还是一次匹配所有的 block tag.</p>
<h3 id="添加单侧"><a href="#添加单侧" class="headerlink" title="添加单侧"></a>添加单侧</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;render() - tag prefix collision during escape swig tag (issue #xxx)&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;testtagblock&#x27;</span>, <span class="function">(<span class="params">args, content</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;rendered_test_tag_block&#x27;</span>;</span><br><span class="line">  &#125;, &#123; <span class="attr">ends</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;testtag&#x27;</span>, <span class="function"><span class="params">args</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;rendered_test_tag&#x27;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> content = [</span><br><span class="line">    <span class="string">&#x27;x&#123;% testtag name  %&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;## Title&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;% testtagblock %&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;content in block tag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;% endtesttagblock %&#125;&#x27;</span></span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> post.<span class="title function_">render</span>(<span class="string">&#x27;&#x27;</span>, &#123;</span><br><span class="line">    content,</span><br><span class="line">    <span class="attr">engine</span>: <span class="string">&#x27;markdown&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">unregister</span>(<span class="string">&#x27;testtagblock&#x27;</span>);</span><br><span class="line">  hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">unregister</span>(<span class="string">&#x27;testtag&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  data.<span class="property">content</span>.<span class="property">should</span>.<span class="title function_">contains</span>(<span class="string">&#x27;rendered_test_tag_block&#x27;</span>);</span><br><span class="line">  data.<span class="property">content</span>.<span class="property">should</span>.<span class="title function_">contains</span>(<span class="string">&#x27;rendered_test_tag&#x27;</span>);</span><br><span class="line">  data.<span class="property">content</span>.<span class="property">should</span>.<span class="title function_">contains</span>(<span class="string">&#x27;&lt;h2&#x27;</span>);</span><br><span class="line">  data.<span class="property">content</span>.<span class="property">should</span>.<span class="property">not</span>.<span class="title function_">contains</span>(<span class="string">&#x27;## Title&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><p>最痛苦的就是写 Issue 了, 写的需要非常详细, 预期效果, 实际效果, 尝试解决的思路等等. 然后 fork 下, 自己本地仓库代码 push 上去, 提个 pr, 把两种方案都给管理员, 等待进一步的反馈. Issue: <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues/5635">https://github.com/hexojs/hexo/issues/5635</a>.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>发个博客卡了一周, 断断续续处理了十来个小时.</p>
<p>不管哪一个实现, 都对于 nunjucks 支持非常有限, 包括</p>
<ol>
<li><strong>不支持 block tag 的 begin end 名称不同</strong>, 比如 <a target="_blank" rel="noopener" href="https://mozilla.github.io/nunjucks/templating.html#asynceach"><code>asyncEach</code></a></li>
<li><code>else</code> 任何 block tag 中的内容会被 escape. 我认为除了 <code>row</code>, <code>code</code> 几个少量标签确实需要整个都 escape. <strong>一些其他的 block tag, 可能未必需要 escape 中间的内容</strong>. 比如我一直使用索引列表中的标签, 我下意识使用了 hexo 的 link, 但是从流程来看如果使用 md 语法就无法渲染. 这个可能需要添加一个 <code>escapeContent</code> 之类的标签, 注册的时候直接给标记上是否需要 escape 中间部分, 还是只 escape tag 本身 (配合是否 block tag 的标记).</li>
<li><strong>无法支持嵌套的 tag</strong>, 比如嵌套两个 <code>if</code> 就无法正确 escape 第二个 <code>endif</code>.</li>
</ol>
<p>后续优化可以是:</p>
<ol>
<li>更好的 nujucks 的支持.</li>
<li><code>escapeAllSwigTags</code> 函数的代码优化</li>
</ol>
<p>有一些困惑:</p>
<ul>
<li>为什么要先渲染 md 再渲染标签呢; 先渲染标签为 html, 再渲染 md 就能支持完整的 nujucks 的各种语法了 (虽然一般用不到)</li>
</ul>

    </div>

    
    
    

      <div> <div class="my-post-copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">

  <p><span>本文标题:</span>给 Hexo 提交 PR</a></p>
  <p><span>文章作者:</span></a></p>
  <p><span>发布时间:</span>2025年02月20日 - 08:30:22</p>
  <p><span>最后更新:</span>2025年02月20日 - 09:18:36</p>
  <p><span>原始链接:</span><a href="/2025/fix-hexo-tag-escape/" title="给 Hexo 提交 PR">https://zombie12138.github.io/2025/fix-hexo-tag-escape/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://zombie12138.github.io/2025/fix-hexo-tag-escape/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>特殊声明:</span>本篇文章由我个人在空闲时间独立制作。所有观点、看法及内容均为个人意见，不代表任何组织或公司的立场。</p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({
          title: "",
          text: '复制成功',
          html: false,
          timer: 500,
          showConfirmButton: false
        });
      });
    }));
</script>
 </div>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/hexo/" rel="tag"># hexo</a>
              <a href="/tags/js/" rel="tag"># js</a>
              <a href="/tags/Github/" rel="tag"># Github</a>
              <a href="/tags/OpenSource/" rel="tag"># OpenSource</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/implement-of-lua/" rel="prev" title="小而美的 Lua 实现 | Impliment of Lua">
      <i class="fa fa-chevron-left"></i> 小而美的 Lua 实现 | Impliment of Lua
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%B0%E8%B1%A1"><span class="nav-number">1.1.</span> <span class="nav-text">现象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">版本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.3.</span> <span class="nav-text">问题复现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">2.</span> <span class="nav-text">问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hexo-reference-plus"><span class="nav-number">2.1.</span> <span class="nav-text">hexo-reference-plus</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hexo-renderer-marked"><span class="nav-number">2.2.</span> <span class="nav-text">hexo-renderer-marked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hexo"><span class="nav-number">2.3.</span> <span class="nav-text">hexo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.</span> <span class="nav-text">问题修复</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Blame"><span class="nav-number">3.1.</span> <span class="nav-text">Blame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E7%8E%B0%E8%A2%AB%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.2.</span> <span class="nav-text">发现被修复?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="nav-number">3.3.</span> <span class="nav-text">修复方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83"><span class="nav-number">3.4.</span> <span class="nav-text">安装环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E5%AE%9E%E7%8E%B0-%E9%80%9A%E8%BF%87%E8%AE%B0%E5%BD%95%E6%A0%87%E7%AD%BE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.5.</span> <span class="nav-text">修复实现 (通过记录标签类型)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E5%AE%9E%E7%8E%B0-%E9%80%9A%E8%BF%87%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="nav-number">3.6.</span> <span class="nav-text">修复实现 (通过正则匹配)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%8D%95%E4%BE%A7"><span class="nav-number">3.7.</span> <span class="nav-text">添加单侧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4"><span class="nav-number">3.8.</span> <span class="nav-text">提交</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zombie12138</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zombie12138</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
